# Butterfly

A sync engine for atproto with an optional baked-in database.

```
# Sync from a CAR file
butterfly sync --input carfile --car file.car --did did:plc:example --store duckdb

# Sync from a PDS
butterfly sync --input pds --pds https://pds.example.com --did did:plc:example

# Subscribe to a relay
butterfly sync --input relay --relay wss://relay.example.com --store stdout

# Discover repositories on a PDS
butterfly discover --input pds --pds https://pds.example.com --limit 50 --format json

# Discover with identity resolution
butterfly discover --input relay --relay wss://relay.example.com  --store stdout
```

## WIP notes

- Until the Store interface has stabilized, let's only work on stdout and duckdb to keep things simple.

```
go run ./cmd/butterfly sync -input pds -pds https://morel.us-east.host.bsky.network -did did:plc:ragtjsm2j2vknwkz3zp4oxrd -store duckdb -db ~/tmp/test-tarfiles/duckdb.sql
go run ./cmd/butterfly sync -input carfile -car /Users/paulfrazee/tmp/carfiles/pfrazee.car -did did:plc:ragtjsm2j2vknwkz3zp4oxrd -store duckdb -db ~/tmp/test-tarfiles/duckdb.sql
go run ./cmd/butterfly discover -input pds -pds https://morel.us-east.host.bsky.network -limit 10 -store stdout
```

## TODOs

v1

- Backfill
  - Implement all Remote FetchRepo
  - Implement all Remote ListRepos
  - Implement bidi identity resolution and caching
- Core
  - Implement a work-scheduler which abstracts Remote, Identity, and Store to backfill using Selectors
  - Track "known" Lexicons and maintain an active definitions cache
  - Automatically generate secondary indexes which are generally useful
  - Investigate indexes generated by Lexicon definitions
  - Implement Store querying interfaces
- Active sync
  - Implement all Remote SyncRecords
  - Update sync-state-tracking (repo state)
- Interface
  - Create v1 CLI and APIs

future

- A local data read/write model, perhaps modeled as virtual local users
- Prometheus endpoints

## Example selectors

My data:

```json
{
  "select": [
    {
      "where": {"repo": "at://pfrazee.com"},
      "tag": "user"
    }
  ],
  "retain": {
    "user": {"*": "*"},
  }
}
```

A list of repos:

```json
{
  "select": [
    {"where": {"repo": "at://pfrazee.com"}, "tag": "user"},
    {"where": {"repo": "at://atproto.com"}, "tag": "user"},
    {"where": {"repo": "at://bsky.app"}, "tag": "user"}
  ],
  "retain": {
    "user": {"*": "*"},
  }
}
```

My personal network:

```json
{
  "select": [
    {
      "where": {"repo": "at://pfrazee.com"},
      "tag": "me"
    },
    {
      "where": {"repo": "me", "collection": "app.bsky.graph.follow", "attr": "subject"},
      "tag": "followed"
    },
    {
      "where": {"repo": "followed", "collection": "app.bsky.graph.follow", "attr": "subject"},
      "tag": "k2-followed"
    }
  ],
  "retain": {
    "me": {"*": "*"},
    "followed": : {"*": "*"},
    "k2-followed": {
      "app.bsky.actor.profile": "self",
      "app.bsky.graph.follow": "latest:3000",
      "app.bsky.feed.post": "latest:10",
      "app.bsky.feed.repost": "latest:10",
      "app.bsky.feed.like": "latest:100",
      "app.bsky.*": "latest:1000"
    }
  }
}
```

Recursive crawl from me:

```json
{
  "select": [
    {
      "where": {"repo": "at://pfrazee.com"},
      "tag": "user"
    },
    {
      "where": {"repo": "user", "collection": "app.bsky.graph.follow", "attr": "subject"},
      "tag": "user"
    }
  ],
  "retain": {
    "user": {"*": "*"},
  }
}
```

All users tracked by bluesky's collection index:

```json
{
  "select": [
    {
      "where": {
        "service": "bsky.network",
        "method": "com.atproto.sync.listReposByCollection",
        "params": {"collection": "app.bsky.actor.profile"},
        "attr": "repos.*.did",
        "pagination": {"param": "cursor", "attr": "cursor"}
      },
      "tag": "bluesky-user"
    }
  ],
  "retain": {
    "bluesky-user": {"app.bsky.*": "*"}
  }
}
```
